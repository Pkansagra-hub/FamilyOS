{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "title": "Retrieval QoS Event Schema",
    "description": "Event schema for QoS-related retrieval events",
    "type": "object",
    "allOf": [
        {
            "$ref": "../envelope.schema.json"
        },
        {
            "properties": {
                "event_type": {
                    "enum": [
                        "QOS_BUDGET_EXCEEDED",
                        "QOS_METRICS_UPDATED"
                    ]
                },
                "payload": {
                    "oneOf": [
                        {
                            "type": "object",
                            "description": "QoS Budget Exceeded Event",
                            "properties": {
                                "event_subtype": {
                                    "const": "budget_exceeded"
                                },
                                "request_id": {
                                    "type": "string",
                                    "description": "Request that exceeded budget"
                                },
                                "user_id": {
                                    "type": "string",
                                    "description": "User whose request exceeded budget"
                                },
                                "stage": {
                                    "type": "string",
                                    "enum": [
                                        "policy_evaluation",
                                        "fts_search",
                                        "vector_search",
                                        "kg_search",
                                        "fusion",
                                        "ranking",
                                        "mmr_diversity",
                                        "reranking",
                                        "calibration",
                                        "response_building"
                                    ],
                                    "description": "Processing stage where budget was exceeded"
                                },
                                "budget_ms": {
                                    "type": "integer",
                                    "minimum": 1,
                                    "maximum": 1000,
                                    "description": "Allocated budget in milliseconds"
                                },
                                "actual_ms": {
                                    "type": "number",
                                    "minimum": 0,
                                    "description": "Actual time taken in milliseconds"
                                },
                                "action_taken": {
                                    "type": "string",
                                    "enum": [
                                        "graceful_degradation",
                                        "request_cancelled",
                                        "partial_results",
                                        "budget_extension"
                                    ],
                                    "description": "Action taken when budget exceeded"
                                },
                                "degradation_details": {
                                    "type": "object",
                                    "properties": {
                                        "skipped_stages": {
                                            "type": "array",
                                            "items": {
                                                "type": "string"
                                            }
                                        },
                                        "reduced_k": {
                                            "type": "integer",
                                            "minimum": 1
                                        },
                                        "simplified_ranking": {
                                            "type": "boolean"
                                        }
                                    },
                                    "additionalProperties": false
                                }
                            },
                            "required": [
                                "event_subtype",
                                "request_id",
                                "user_id",
                                "stage",
                                "budget_ms",
                                "actual_ms",
                                "action_taken"
                            ],
                            "additionalProperties": false
                        },
                        {
                            "type": "object",
                            "description": "QoS Metrics Updated Event",
                            "properties": {
                                "event_subtype": {
                                    "const": "metrics_updated"
                                },
                                "window_start": {
                                    "type": "string",
                                    "format": "date-time",
                                    "description": "Start of measurement window"
                                },
                                "window_end": {
                                    "type": "string",
                                    "format": "date-time",
                                    "description": "End of measurement window"
                                },
                                "window_duration_seconds": {
                                    "type": "integer",
                                    "minimum": 1,
                                    "description": "Window duration in seconds"
                                },
                                "metrics": {
                                    "type": "object",
                                    "properties": {
                                        "total_requests": {
                                            "type": "integer",
                                            "minimum": 0,
                                            "description": "Total requests processed"
                                        },
                                        "successful_requests": {
                                            "type": "integer",
                                            "minimum": 0,
                                            "description": "Successfully completed requests"
                                        },
                                        "failed_requests": {
                                            "type": "integer",
                                            "minimum": 0,
                                            "description": "Failed requests"
                                        },
                                        "avg_latency_ms": {
                                            "type": "number",
                                            "minimum": 0,
                                            "description": "Average latency in milliseconds"
                                        },
                                        "p50_latency_ms": {
                                            "type": "number",
                                            "minimum": 0,
                                            "description": "50th percentile latency"
                                        },
                                        "p95_latency_ms": {
                                            "type": "number",
                                            "minimum": 0,
                                            "description": "95th percentile latency"
                                        },
                                        "p99_latency_ms": {
                                            "type": "number",
                                            "minimum": 0,
                                            "description": "99th percentile latency"
                                        },
                                        "success_rate": {
                                            "type": "number",
                                            "minimum": 0,
                                            "maximum": 1,
                                            "description": "Success rate as a fraction"
                                        },
                                        "budget_exceeded_rate": {
                                            "type": "number",
                                            "minimum": 0,
                                            "maximum": 1,
                                            "description": "Rate of budget exceeded events"
                                        },
                                        "avg_result_count": {
                                            "type": "number",
                                            "minimum": 0,
                                            "description": "Average number of results returned"
                                        },
                                        "cache_hit_rate": {
                                            "type": "number",
                                            "minimum": 0,
                                            "maximum": 1,
                                            "description": "Cache hit rate for queries"
                                        }
                                    },
                                    "required": [
                                        "total_requests",
                                        "successful_requests",
                                        "failed_requests",
                                        "avg_latency_ms",
                                        "p95_latency_ms",
                                        "p99_latency_ms",
                                        "success_rate",
                                        "budget_exceeded_rate"
                                    ],
                                    "additionalProperties": false
                                },
                                "by_user_role": {
                                    "type": "object",
                                    "patternProperties": {
                                        "^(memory_reader|memory_analyst|memory_admin)$": {
                                            "type": "object",
                                            "properties": {
                                                "request_count": {
                                                    "type": "integer",
                                                    "minimum": 0
                                                },
                                                "avg_latency_ms": {
                                                    "type": "number",
                                                    "minimum": 0
                                                },
                                                "success_rate": {
                                                    "type": "number",
                                                    "minimum": 0,
                                                    "maximum": 1
                                                }
                                            },
                                            "required": [
                                                "request_count",
                                                "avg_latency_ms",
                                                "success_rate"
                                            ]
                                        }
                                    },
                                    "additionalProperties": false
                                },
                                "by_space_type": {
                                    "type": "object",
                                    "patternProperties": {
                                        "^(personal|selective|shared|extended|interfamily)$": {
                                            "type": "object",
                                            "properties": {
                                                "request_count": {
                                                    "type": "integer",
                                                    "minimum": 0
                                                },
                                                "avg_latency_ms": {
                                                    "type": "number",
                                                    "minimum": 0
                                                },
                                                "success_rate": {
                                                    "type": "number",
                                                    "minimum": 0,
                                                    "maximum": 1
                                                }
                                            },
                                            "required": [
                                                "request_count",
                                                "avg_latency_ms",
                                                "success_rate"
                                            ]
                                        }
                                    },
                                    "additionalProperties": false
                                }
                            },
                            "required": [
                                "event_subtype",
                                "window_start",
                                "window_end",
                                "window_duration_seconds",
                                "metrics"
                            ],
                            "additionalProperties": false
                        }
                    ]
                }
            }
        }
    ],
    "examples": [
        {
            "id": "evt_qos_exceeded_001",
            "event_type": "QOS_BUDGET_EXCEEDED",
            "timestamp": "2025-09-16T10:30:00.078Z",
            "source": "retrieval.qos_gate",
            "space_id": "shared:research_team",
            "user_id": "alice_researcher",
            "trace_id": "a1b2c3d4e5f6789012345678deadbeef",
            "version": "1.0.0",
            "payload": {
                "event_subtype": "budget_exceeded",
                "request_id": "req_20250916_002",
                "user_id": "alice_researcher",
                "stage": "vector_search",
                "budget_ms": 100,
                "actual_ms": 156.3,
                "action_taken": "graceful_degradation",
                "degradation_details": {
                    "skipped_stages": [
                        "reranking"
                    ],
                    "reduced_k": 25,
                    "simplified_ranking": true
                }
            }
        },
        {
            "id": "evt_qos_metrics_001",
            "event_type": "QOS_METRICS_UPDATED",
            "timestamp": "2025-09-16T11:00:00.000Z",
            "source": "retrieval.metrics_collector",
            "space_id": "system:metrics",
            "user_id": "system",
            "trace_id": "metrics_hourly_20250916_11",
            "version": "1.0.0",
            "payload": {
                "event_subtype": "metrics_updated",
                "window_start": "2025-09-16T10:00:00.000Z",
                "window_end": "2025-09-16T11:00:00.000Z",
                "window_duration_seconds": 3600,
                "metrics": {
                    "total_requests": 1247,
                    "successful_requests": 1242,
                    "failed_requests": 5,
                    "avg_latency_ms": 34.2,
                    "p50_latency_ms": 28.1,
                    "p95_latency_ms": 87.5,
                    "p99_latency_ms": 234.1,
                    "success_rate": 0.996,
                    "budget_exceeded_rate": 0.008,
                    "avg_result_count": 8.3,
                    "cache_hit_rate": 0.23
                },
                "by_user_role": {
                    "memory_reader": {
                        "request_count": 856,
                        "avg_latency_ms": 29.1,
                        "success_rate": 0.998
                    },
                    "memory_analyst": {
                        "request_count": 347,
                        "avg_latency_ms": 42.6,
                        "success_rate": 0.994
                    },
                    "memory_admin": {
                        "request_count": 44,
                        "avg_latency_ms": 67.8,
                        "success_rate": 0.977
                    }
                }
            }
        }
    ]
}
