{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://memory-os.ai/schemas/storage/privacy_policy.schema.json",
  "title": "Privacy Policy Storage Schema",
  "description": "Schema for storing privacy policies, consent records, and redaction rules in MemoryOS",
  "type": "object",
  "required": ["policy_id", "space_id", "policy_type", "created_at", "created_by"],
  "properties": {
    "policy_id": {
      "type": "string",
      "pattern": "^policy-[a-f0-9]{16}$",
      "description": "Unique identifier for the privacy policy"
    },
    "space_id": {
      "type": "string",
      "description": "Space scope for the policy (shared:household, personal:alice, etc.)"
    },
    "policy_type": {
      "type": "string",
      "enum": ["consent", "redaction", "retention", "sharing", "access_control"],
      "description": "Type of privacy policy"
    },
    "policy_name": {
      "type": "string",
      "maxLength": 255,
      "description": "Human-readable name for the policy"
    },
    "policy_description": {
      "type": "string",
      "maxLength": 1000,
      "description": "Detailed description of the policy"
    },
    "created_at": {
      "type": "number",
      "description": "Unix timestamp when policy was created"
    },
    "created_by": {
      "type": "string",
      "description": "Actor who created the policy"
    },
    "updated_at": {
      "type": "number",
      "description": "Unix timestamp when policy was last updated"
    },
    "updated_by": {
      "type": "string",
      "description": "Actor who last updated the policy"
    },
    "effective_from": {
      "type": "number",
      "description": "Unix timestamp when policy becomes effective"
    },
    "effective_until": {
      "type": "number",
      "description": "Unix timestamp when policy expires (null for indefinite)"
    },
    "policy_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the policy"
    },
    "supersedes": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^policy-[a-f0-9]{16}$"
      },
      "description": "Array of policy IDs that this policy supersedes"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "active", "suspended", "revoked", "expired"],
      "description": "Current status of the policy"
    },
    "scope": {
      "type": "object",
      "description": "Scope definition for the policy",
      "properties": {
        "data_types": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["memory", "affect", "temporal", "drives", "social", "all"]
          },
          "description": "Data types this policy applies to"
        },
        "operations": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["read", "write", "delete", "share", "export", "sync", "all"]
          },
          "description": "Operations this policy applies to"
        },
        "actors": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Specific actors this policy applies to (empty for all)"
        },
        "spaces": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Specific spaces this policy applies to (empty for current space)"
        }
      },
      "additionalProperties": false
    },
    "consent_policy": {
      "type": "object",
      "description": "Consent management configuration",
      "properties": {
        "consent_required": {
          "type": "boolean",
          "description": "Whether explicit consent is required"
        },
        "consent_granularity": {
          "type": "string",
          "enum": ["global", "space", "data_type", "operation", "record"],
          "description": "Level of granularity for consent"
        },
        "consent_method": {
          "type": "string",
          "enum": ["explicit", "implicit", "opt_out", "parental"],
          "description": "Method of obtaining consent"
        },
        "consent_duration": {
          "type": "number",
          "description": "Duration of consent in seconds (null for indefinite)"
        },
        "withdrawal_allowed": {
          "type": "boolean",
          "description": "Whether consent can be withdrawn"
        },
        "withdrawal_effects": {
          "type": "string",
          "enum": ["immediate", "deferred", "prospective"],
          "description": "Effects of consent withdrawal"
        },
        "parental_consent_age": {
          "type": "number",
          "minimum": 0,
          "maximum": 18,
          "description": "Age below which parental consent is required"
        }
      },
      "additionalProperties": false
    },
    "redaction_policy": {
      "type": "object",
      "description": "Data redaction and minimization rules",
      "properties": {
        "redaction_triggers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "condition": {
                "type": "string",
                "enum": ["always", "external_access", "untrusted_device", "time_based", "context_based"],
                "description": "Condition that triggers redaction"
              },
              "categories": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["pii.email", "pii.phone", "pii.address", "pii.ssn", "pii.cc", "pii.ip", "biometric", "location", "financial", "health", "custom"]
                },
                "description": "Categories of data to redact"
              },
              "redaction_method": {
                "type": "string",
                "enum": ["remove", "mask", "hash", "tokenize", "generalize"],
                "description": "Method to use for redaction"
              },
              "replacement_pattern": {
                "type": "string",
                "description": "Pattern to use for replacement (e.g., [REDACTED], ***)"
              }
            },
            "required": ["condition", "categories", "redaction_method"],
            "additionalProperties": false
          },
          "description": "Rules for when and how to redact data"
        },
        "retention_overrides": {
          "type": "object",
          "properties": {
            "original_retention_days": {
              "type": "number",
              "minimum": 0,
              "description": "Override for original data retention"
            },
            "redacted_retention_days": {
              "type": "number",
              "minimum": 0,
              "description": "Retention period for redacted data"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "retention_policy": {
      "type": "object",
      "description": "Data retention and deletion rules",
      "properties": {
        "default_retention_days": {
          "type": "number",
          "minimum": 0,
          "description": "Default retention period in days"
        },
        "max_retention_days": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum allowed retention period"
        },
        "retention_overrides": {
          "type": "object",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "number",
              "minimum": 0,
              "description": "Retention override for specific data type"
            }
          },
          "additionalProperties": false
        },
        "deletion_method": {
          "type": "string",
          "enum": ["soft", "hard", "crypto_shred"],
          "description": "Method to use for data deletion"
        },
        "deletion_verification": {
          "type": "boolean",
          "description": "Whether to verify successful deletion"
        },
        "deletion_grace_period": {
          "type": "number",
          "minimum": 0,
          "description": "Grace period before permanent deletion in days"
        }
      },
      "additionalProperties": false
    },
    "sharing_policy": {
      "type": "object",
      "description": "Rules for sharing data across spaces or externally",
      "properties": {
        "sharing_allowed": {
          "type": "boolean",
          "description": "Whether sharing is allowed at all"
        },
        "allowed_destinations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Allowed destination spaces or external systems"
        },
        "sharing_purpose": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["family_coordination", "emergency", "medical", "legal", "educational", "research", "backup"]
          },
          "description": "Allowed purposes for sharing"
        },
        "anonymization_required": {
          "type": "boolean",
          "description": "Whether data must be anonymized before sharing"
        },
        "encryption_required": {
          "type": "boolean",
          "description": "Whether data must be encrypted for sharing"
        },
        "audit_sharing": {
          "type": "boolean",
          "description": "Whether to audit all sharing operations"
        }
      },
      "additionalProperties": false
    },
    "access_control_policy": {
      "type": "object",
      "description": "Access control rules and restrictions",
      "properties": {
        "role_restrictions": {
          "type": "object",
          "patternProperties": {
            "^[a-zA-Z_][a-zA-Z0-9_]*$": {
              "type": "object",
              "properties": {
                "allowed_operations": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["read", "write", "delete", "share", "admin"]
                  }
                },
                "time_restrictions": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "start_hour": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 23
                      },
                      "end_hour": {
                        "type": "number",
                        "minimum": 0,
                        "maximum": 23
                      },
                      "days": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "enum": ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
                        }
                      }
                    },
                    "required": ["start_hour", "end_hour"],
                    "additionalProperties": false
                  }
                },
                "device_restrictions": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["trusted", "untrusted", "mobile", "desktop", "shared"]
                  }
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "emergency_override": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether emergency override is enabled"
            },
            "override_roles": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Roles that can trigger emergency override"
            },
            "audit_override": {
              "type": "boolean",
              "description": "Whether to audit emergency overrides"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "compliance_metadata": {
      "type": "object",
      "description": "Metadata for regulatory compliance",
      "properties": {
        "applicable_regulations": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["GDPR", "CCPA", "HIPAA", "COPPA", "SOX", "FERPA"]
          },
          "description": "Applicable regulatory frameworks"
        },
        "legal_basis": {
          "type": "string",
          "enum": ["consent", "contract", "legal_obligation", "vital_interests", "public_task", "legitimate_interests"],
          "description": "Legal basis for data processing (GDPR)"
        },
        "data_controller": {
          "type": "string",
          "description": "Entity responsible for data processing decisions"
        },
        "data_processor": {
          "type": "string",
          "description": "Entity performing data processing"
        },
        "dpo_contact": {
          "type": "string",
          "description": "Data Protection Officer contact information"
        },
        "privacy_notice": {
          "type": "string",
          "description": "Reference to privacy notice or policy document"
        }
      },
      "additionalProperties": false
    },
    "enforcement_metadata": {
      "type": "object",
      "description": "Policy enforcement tracking",
      "properties": {
        "last_enforced": {
          "type": "number",
          "description": "Timestamp of last enforcement"
        },
        "enforcement_count": {
          "type": "number",
          "minimum": 0,
          "description": "Total number of enforcements"
        },
        "violations_detected": {
          "type": "number",
          "minimum": 0,
          "description": "Number of policy violations detected"
        },
        "violations_resolved": {
          "type": "number",
          "minimum": 0,
          "description": "Number of violations resolved"
        },
        "automated_enforcement": {
          "type": "boolean",
          "description": "Whether enforcement is automated"
        },
        "enforcement_actions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "action_id": {
                "type": "string"
              },
              "action_type": {
                "type": "string",
                "enum": ["block", "redact", "audit", "notify", "delete"]
              },
              "timestamp": {
                "type": "number"
              },
              "details": {
                "type": "object",
                "additionalProperties": true
              }
            },
            "required": ["action_id", "action_type", "timestamp"],
            "additionalProperties": false
          },
          "description": "Log of enforcement actions taken"
        }
      },
      "additionalProperties": false
    },
    "custom_rules": {
      "type": "object",
      "description": "Custom policy rules and configurations",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "description": "Custom rule configuration",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "policy_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of policy content for integrity verification"
    },
    "signature": {
      "type": "string",
      "description": "Digital signature for policy authenticity"
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "policy_id": "policy-a1b2c3d4e5f67890",
      "space_id": "shared:household",
      "policy_type": "consent",
      "policy_name": "Family Photo Sharing Consent",
      "policy_description": "Manages consent for sharing family photos outside household",
      "created_at": 1672531200.0,
      "created_by": "alice",
      "effective_from": 1672531200.0,
      "policy_version": "1.0.0",
      "status": "active",
      "scope": {
        "data_types": ["memory"],
        "operations": ["share"],
        "actors": [],
        "spaces": ["interfamily:*"]
      },
      "consent_policy": {
        "consent_required": true,
        "consent_granularity": "operation",
        "consent_method": "explicit",
        "consent_duration": 2592000,
        "withdrawal_allowed": true,
        "withdrawal_effects": "immediate",
        "parental_consent_age": 13
      },
      "sharing_policy": {
        "sharing_allowed": true,
        "allowed_destinations": ["interfamily:famA-famB"],
        "sharing_purpose": ["family_coordination"],
        "anonymization_required": false,
        "encryption_required": true,
        "audit_sharing": true
      },
      "compliance_metadata": {
        "applicable_regulations": ["GDPR", "COPPA"],
        "legal_basis": "consent",
        "data_controller": "family:household",
        "privacy_notice": "https://example.com/privacy"
      }
    }
  ]
}
