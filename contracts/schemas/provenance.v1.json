{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "MemoryOS Data Provenance Schema v1",
  "description": "Data lineage schema for source, transformations, model version, and policy obligations in the Memory-Centric Family AI system",
  "type": "object",
  "version": "1.0.0",

  "$defs": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp with timezone"
    },

    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID format identifier"
    },

    "family_context": {
      "type": "object",
      "properties": {
        "family_id": {"$ref": "#/$defs/uuid"},
        "family_member_id": {"$ref": "#/$defs/uuid"},
        "relationship_context": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Active family relationships affecting data processing"
        },
        "privacy_level": {
          "type": "string",
          "enum": ["personal", "family_selective", "family_shared", "extended_family"],
          "description": "Family privacy classification"
        }
      },
      "required": ["family_id"],
      "additionalProperties": false
    },

    "data_source": {
      "type": "object",
      "properties": {
        "source_id": {"$ref": "#/$defs/uuid"},
        "source_type": {
          "type": "string",
          "enum": ["user_input", "device_sensor", "family_interaction", "external_connector", "ai_generated", "memory_recall"]
        },
        "source_name": {"type": "string"},
        "source_version": {"type": "string"},
        "collected_at": {"$ref": "#/$defs/timestamp"},
        "family_context": {"$ref": "#/$defs/family_context"},
        "metadata": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "required": ["source_id", "source_type", "collected_at", "family_context"],
      "additionalProperties": false
    },

    "transformation": {
      "type": "object",
      "properties": {
        "transformation_id": {"$ref": "#/$defs/uuid"},
        "transformation_type": {
          "type": "string",
          "enum": ["encoding", "embedding", "classification", "summarization", "anonymization", "family_contextualization", "memory_formation"]
        },
        "transformation_name": {"type": "string"},
        "model_name": {"type": "string"},
        "model_version": {"type": "string"},
        "parameters": {
          "type": "object",
          "additionalProperties": true
        },
        "applied_at": {"$ref": "#/$defs/timestamp"},
        "family_context_preserved": {"type": "boolean"},
        "privacy_impact": {
          "type": "string",
          "enum": ["none", "redaction", "anonymization", "family_filtering", "age_restriction"]
        }
      },
      "required": ["transformation_id", "transformation_type", "applied_at"],
      "additionalProperties": false
    },

    "policy_obligation": {
      "type": "object",
      "properties": {
        "obligation_id": {"$ref": "#/$defs/uuid"},
        "obligation_type": {
          "type": "string",
          "enum": ["consent", "retention", "deletion", "redaction", "family_access", "age_restriction", "relationship_access"]
        },
        "obligation_description": {"type": "string"},
        "family_scope": {
          "type": "array",
          "items": {"$ref": "#/$defs/uuid"},
          "description": "Family member IDs affected by this obligation"
        },
        "expiry_date": {"$ref": "#/$defs/timestamp"},
        "compliance_status": {
          "type": "string",
          "enum": ["compliant", "pending", "violated", "expired"]
        },
        "enforcement_actions": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["delete", "redact", "restrict_access", "notify_family", "audit_log"]
          }
        }
      },
      "required": ["obligation_id", "obligation_type", "compliance_status"],
      "additionalProperties": false
    }
  },

  "properties": {
    "provenance_id": {
      "$ref": "#/$defs/uuid",
      "description": "Unique identifier for this provenance record"
    },

    "data_id": {
      "$ref": "#/$defs/uuid",
      "description": "Identifier of the data artifact this provenance describes"
    },

    "family_context": {
      "$ref": "#/$defs/family_context",
      "description": "Family context for this data provenance"
    },

    "data_classification": {
      "type": "string",
      "enum": ["family_memory", "personal_data", "shared_knowledge", "public_information", "sensitive_family_data"],
      "description": "Classification of data for family privacy and access control"
    },

    "sources": {
      "type": "array",
      "items": {"$ref": "#/$defs/data_source"},
      "description": "All data sources that contributed to this artifact",
      "minItems": 1
    },

    "transformations": {
      "type": "array",
      "items": {"$ref": "#/$defs/transformation"},
      "description": "All transformations applied to create this artifact"
    },

    "policy_obligations": {
      "type": "array",
      "items": {"$ref": "#/$defs/policy_obligation"},
      "description": "Policy obligations governing this data artifact"
    },

    "lineage_graph": {
      "type": "object",
      "properties": {
        "parent_artifacts": {
          "type": "array",
          "items": {"$ref": "#/$defs/uuid"},
          "description": "Data artifacts that were used to create this one"
        },
        "child_artifacts": {
          "type": "array",
          "items": {"$ref": "#/$defs/uuid"},
          "description": "Data artifacts created from this one"
        },
        "related_memories": {
          "type": "array",
          "items": {"$ref": "#/$defs/uuid"},
          "description": "Family memories related to this data"
        }
      },
      "additionalProperties": false
    },

    "audit_trail": {
      "type": "object",
      "properties": {
        "created_at": {"$ref": "#/$defs/timestamp"},
        "created_by": {"$ref": "#/$defs/uuid"},
        "last_modified_at": {"$ref": "#/$defs/timestamp"},
        "last_modified_by": {"$ref": "#/$defs/uuid"},
        "access_history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "accessed_at": {"$ref": "#/$defs/timestamp"},
              "accessed_by": {"$ref": "#/$defs/uuid"},
              "access_type": {
                "type": "string",
                "enum": ["read", "write", "transform", "share", "delete"]
              },
              "family_context": {"$ref": "#/$defs/family_context"}
            },
            "required": ["accessed_at", "accessed_by", "access_type"],
            "additionalProperties": false
          }
        }
      },
      "required": ["created_at", "created_by"],
      "additionalProperties": false
    },

    "quality_metrics": {
      "type": "object",
      "properties": {
        "completeness_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Completeness of family context and provenance information"
        },
        "accuracy_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Accuracy of family relationship and context information"
        },
        "freshness_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "How recent and up-to-date the family information is"
        },
        "family_relevance_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Relevance of this data to family intelligence and memory"
        }
      },
      "additionalProperties": false
    },

    "retention_policy": {
      "type": "object",
      "properties": {
        "retention_period_days": {"type": "integer", "minimum": 0},
        "deletion_policy": {
          "type": "string",
          "enum": ["hard_delete", "soft_delete", "archive", "anonymize", "family_controlled"]
        },
        "family_override_allowed": {"type": "boolean"},
        "automatic_deletion_date": {"$ref": "#/$defs/timestamp"}
      },
      "additionalProperties": false
    },

    "family_sharing": {
      "type": "object",
      "properties": {
        "shareable_with_family": {"type": "boolean"},
        "age_restrictions": {
          "type": "object",
          "properties": {
            "minimum_age": {"type": "integer", "minimum": 0, "maximum": 100},
            "requires_parent_approval": {"type": "boolean"}
          },
          "additionalProperties": false
        },
        "relationship_restrictions": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["parent", "child", "sibling", "grandparent", "extended_family", "family_friend"]
          },
          "description": "Family relationships that can access this data"
        }
      },
      "additionalProperties": false
    }
  },

  "required": [
    "provenance_id",
    "data_id",
    "family_context",
    "data_classification",
    "sources",
    "audit_trail"
  ],

  "additionalProperties": false,

  "examples": [
    {
      "provenance_id": "01234567-89ab-cdef-0123-456789abcdef",
      "data_id": "01234567-89ab-cdef-0123-456789abcde0",
      "family_context": {
        "family_id": "01234567-89ab-cdef-0123-456789abcde1",
        "family_member_id": "01234567-89ab-cdef-0123-456789abcde2",
        "relationship_context": ["parent", "spouse"],
        "privacy_level": "family_shared"
      },
      "data_classification": "family_memory",
      "sources": [
        {
          "source_id": "01234567-89ab-cdef-0123-456789abcde3",
          "source_type": "family_interaction",
          "source_name": "dinner_conversation",
          "collected_at": "2024-01-15T18:30:00Z",
          "family_context": {
            "family_id": "01234567-89ab-cdef-0123-456789abcde1",
            "privacy_level": "family_shared"
          }
        }
      ],
      "transformations": [
        {
          "transformation_id": "01234567-89ab-cdef-0123-456789abcde4",
          "transformation_type": "memory_formation",
          "transformation_name": "hippocampal_encoding",
          "applied_at": "2024-01-15T18:31:00Z",
          "family_context_preserved": true,
          "privacy_impact": "none"
        }
      ],
      "audit_trail": {
        "created_at": "2024-01-15T18:30:00Z",
        "created_by": "01234567-89ab-cdef-0123-456789abcde2"
      }
    }
  ],

  "$comment": "Memory-Centric Family AI Provenance: Tracks complete data lineage with family context preservation, relationship-aware access control, and family privacy protection throughout all data transformations and memory operations."
}
